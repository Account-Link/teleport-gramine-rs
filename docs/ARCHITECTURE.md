# Teleport Architecture

This document provides a high-level overview of the Teleport project architecture. For detailed API documentation, implementation specifics, and usage examples, please refer to the inline documentation generated by RustDoc.

## Overview

Teleport is a Rust-based application that creates "post once" links for Twitter accounts, leveraging Trusted Execution Environments (TEEs) for security and integrity.

## Key Components

1. **Web Server**: Built using the Axum framework
2. **Database**: SQLite for local storage
3. **Blockchain Interaction**: Using Alloy for NFT minting and management
4. **Twitter API Integration**: Custom Twitter client
5. **OpenAI Integration**: For content filtering using GPT-4
6. **SGX Enclave**: For secure execution and attestation

For detailed API documentation of these components, run `cargo doc` and refer to the generated documentation.

## Project Structure

The project is organized into several key modules:

- [main.rs](/src/main.rs): Entry point of the application
- [actions/](/src/actions/): NFT and wallet operations
- [endpoints.rs](/src/endpoints.rs): HTTP endpoints for the web server
- [twitter/](/src/twitter/): Twitter API integration
- [db/](/src/db/): Database operations
- [sgx_attest](/src/sgx_attest.rs): SGX attestation process
- [oai/](/src/oai.rs): OpenAI integration
- [cert/](/src/cert.rs): Certificate generation and management
- [templates](/templates/modal.html): Web interface HTML templates

For specific implementation details, function descriptions, and usage examples, please refer to the documentation in each file.

## Key Processes

1. NFT Minting and Redemption
   - NFT Creation: When a user authorizes a one-time use token, the system mints an NFT on the Base blockchain.
   - Metadata Generation: The system creates and stores metadata for each NFT, including details about the associated Twitter account and content filter policy.
   - Token Association: Each NFT is linked to a specific Twitter account and content filter policy through its metadata.
   - Redemption Process:
     a. When a post is requested, the system verifies NFT ownership.
     b. If ownership is confirmed, the corresponding NFT is redeemed on-chain.
     c. Upon successful redemption, the tweet is published.
   - Double-Spend Prevention: The blockchain ensures each token is truly "one-use only" by preventing double redemptions.

2. TEE Attestation
   - Key Generation: On startup, the TEE backend generates a private key and stores it securely within the enclave.
   - Key Rotation: The system implements a regular key rotation policy to enhance security, generating new keys at predetermined intervals.
   - Quote Generation: The system produces a remote attestation quote, which includes the current public key.
   - Certificate Creation: A Certificate Signing Request (CSR) is generated and signed by Let's Encrypt.
   - Domain Verification: The certificate proves ownership of the domain `tee.teleport.best`.
   - Certificate Renewal: The system automatically handles certificate renewal before expiration to ensure continuous operation.
   - Revocation Handling: In case of key compromise, the system supports certificate revocation and rapid re-issuance to maintain security.
   - Auditing: The quote and certificate can be verified by auditors to ensure the integrity of the TEE.

3. Authorization Flow
   - Frontend Interaction: User initiates the process on the untrusted frontend.
   - Secure Redirect: User is securely redirected (via HTTPS) to the trusted `tee.teleport.best` domain.
   - TEE Verification: The frontend verifies the TEE's certificate to ensure it's communicating with the genuine trusted environment.
   - Approval Window: An unskippable approval window is presented to the user within the TEE.
   - User Confirmation: User must explicitly approve the creation of each limited-use token.
   - Rate Limiting: The system implements rate limiting to prevent abuse and ensure fair usage.
   - Token Creation: Upon approval, the TEE creates the token and associated NFT.
   - User Feedback: The system provides clear feedback to the user at each step of the process, including success or failure messages.
   - Secure Storage: The created token is securely stored within the TEE, inaccessible to the untrusted frontend.

4. Content Filtering Process
   - Tweet Submission: User submits a tweet for posting.
   - GPT-4o Analysis: The tweet content is sent to OpenAI's GPT-4o for analysis.
   - Policy Enforcement: The system applies the user's predefined content filter policy associated with the NFT.
   - Decision Making: Based on the GPT-4o analysis and policy, the system decides whether to allow or reject the tweet.
   - User Feedback: The user is informed of the decision, with explanations for rejections.
   - Logging: All filtering decisions are logged for auditing purposes, without storing the actual tweet content.

## Security Considerations

- SGX enclave for secure execution
- Remote attestation for code integrity
- Content filtering to prevent misuse
- NFT-based representation of tweet rights to prevent double-spends

## Future Improvements

- Transition from Gramine-SGX to TDX
- Implement a fully decentralized P2P network
- Expand supported social media platforms

For more detailed information on setup and development, refer to the [Development Guide](DEVELOPMENT.md) and the project's [README.md](../README.md).
